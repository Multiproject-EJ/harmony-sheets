<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Harmony Sheets — Admin</title>
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      const globalTarget = typeof globalThis !== 'undefined' ? globalThis : window
      const existingConfig =
        globalTarget.HarmonySheetsSupabase && typeof globalTarget.HarmonySheetsSupabase === 'object'
          ? globalTarget.HarmonySheetsSupabase
          : {}
      globalTarget.HarmonySheetsSupabase = existingConfig

      function assignIfString(key, value) {
        if (typeof value === 'string') {
          const trimmed = value.trim()
          if (trimmed) {
            existingConfig[key] = trimmed
          }
        }
      }

      globalTarget.HarmonySheetsAdminBootConfigReady = (async () => {
        try {
          const {
            SUPABASE_URL,
            SUPABASE_ANON_KEY,
            SUPABASE_ADMIN_EMAIL
          } = await import('../supabase-config.js')

          assignIfString('url', SUPABASE_URL)
          assignIfString('anonKey', SUPABASE_ANON_KEY)
          assignIfString('adminEmail', SUPABASE_ADMIN_EMAIL)
        } catch (error) {
          console.warn('[admin boot] Unable to load supabase-config.js for admin bootstrap.', error)
        }
      })()
    </script>
    <script type="module">
      const script = document.currentScript
      const documentUrl = new URL(script?.src || window.location.href)
      const baseUrl = new URL('./', documentUrl)
      const originUrl = new URL(documentUrl.origin)

      const debugState = { attempts: [], errors: [], status: [] }
      Object.defineProperty(window, 'HarmonySheetsAdminBoot', {
        configurable: true,
        get() {
          return debugState
        }
      })

      const statusContainer = document.createElement('div')
      statusContainer.id = 'admin-bootstrap-status'
      statusContainer.style.position = 'fixed'
      statusContainer.style.inset = '0'
      statusContainer.style.display = 'grid'
      statusContainer.style.placeItems = 'center'
      statusContainer.style.background = 'radial-gradient(rgba(255,255,255,0.9), rgba(255,255,255,0.6))'
      statusContainer.style.zIndex = '2147483647'
      statusContainer.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif'
      statusContainer.style.transition = 'opacity 250ms ease'

      const statusMessage = document.createElement('div')
      statusMessage.style.padding = '1.25rem 1.75rem'
      statusMessage.style.borderRadius = '0.75rem'
      statusMessage.style.boxShadow = '0 1.5rem 3rem rgba(0, 0, 0, 0.15)'
      statusMessage.style.backgroundColor = '#ffffff'
      statusMessage.style.color = '#1f2933'
      statusMessage.style.fontSize = '1rem'
      statusMessage.style.lineHeight = '1.5'
      statusMessage.style.maxWidth = 'min(90vw, 28rem)'
      statusMessage.style.textAlign = 'center'
      statusMessage.style.border = '1px solid rgba(96, 84, 208, 0.15)'
      statusContainer.appendChild(statusMessage)

      const statusDetails = document.createElement('pre')
      statusDetails.style.margin = '0.75rem 0 0'
      statusDetails.style.padding = '0.75rem'
      statusDetails.style.backgroundColor = 'rgba(96, 84, 208, 0.06)'
      statusDetails.style.borderRadius = '0.5rem'
      statusDetails.style.fontSize = '0.85rem'
      statusDetails.style.lineHeight = '1.4'
      statusDetails.style.textAlign = 'left'
      statusDetails.style.whiteSpace = 'pre-wrap'
      statusDetails.style.wordBreak = 'break-word'
      statusDetails.style.border = '1px dashed rgba(96, 84, 208, 0.35)'
      statusDetails.style.display = 'none'
      statusMessage.appendChild(statusDetails)

      const controls = document.createElement('div')
      controls.style.marginTop = '0.75rem'
      controls.style.display = 'flex'
      controls.style.justifyContent = 'center'
      controls.style.gap = '0.5rem'
      statusMessage.appendChild(controls)

      const toggleButton = document.createElement('button')
      toggleButton.type = 'button'
      toggleButton.textContent = 'Show debug details'
      toggleButton.style.padding = '0.35rem 0.75rem'
      toggleButton.style.fontSize = '0.8rem'
      toggleButton.style.borderRadius = '999px'
      toggleButton.style.border = '1px solid rgba(96, 84, 208, 0.35)'
      toggleButton.style.background = '#fff'
      toggleButton.style.color = '#4338ca'
      toggleButton.style.cursor = 'pointer'
      toggleButton.style.transition = 'all 150ms ease'
      toggleButton.addEventListener('mouseenter', () => {
        toggleButton.style.background = 'rgba(79, 70, 229, 0.08)'
      })
      toggleButton.addEventListener('mouseleave', () => {
        toggleButton.style.background = '#fff'
      })
      controls.appendChild(toggleButton)

      const copyButton = document.createElement('button')
      copyButton.type = 'button'
      copyButton.textContent = 'Copy debug JSON'
      copyButton.style.padding = toggleButton.style.padding
      copyButton.style.fontSize = toggleButton.style.fontSize
      copyButton.style.borderRadius = toggleButton.style.borderRadius
      copyButton.style.border = toggleButton.style.border
      copyButton.style.background = toggleButton.style.background
      copyButton.style.color = toggleButton.style.color
      copyButton.style.cursor = toggleButton.style.cursor
      copyButton.style.transition = toggleButton.style.transition
      copyButton.addEventListener('mouseenter', () => {
        copyButton.style.background = 'rgba(79, 70, 229, 0.08)'
      })
      copyButton.addEventListener('mouseleave', () => {
        copyButton.style.background = '#fff'
      })
      controls.appendChild(copyButton)

      let detailsVisible = false
      function updateDetailsVisibility() {
        if (toggleButton.disabled) {
          statusDetails.style.display = 'none'
          toggleButton.textContent = 'No debug details available yet'
          return
        }
        statusDetails.style.display = detailsVisible ? 'block' : 'none'
        toggleButton.textContent = detailsVisible ? 'Hide debug details' : 'Show debug details'
      }
      toggleButton.addEventListener('click', () => {
        detailsVisible = !detailsVisible
        updateDetailsVisibility()
      })

      copyButton.addEventListener('click', async () => {
        const payload = JSON.stringify(debugState, null, 2)
        try {
          if (!navigator.clipboard || typeof navigator.clipboard.writeText !== 'function') {
            throw new Error('Clipboard API is not available in this context.')
          }
          await navigator.clipboard.writeText(payload)
          copyButton.textContent = 'Copied!'
          window.setTimeout(() => {
            copyButton.textContent = 'Copy debug JSON'
          }, 2000)
        } catch (error) {
          console.warn('[admin boot] Failed to copy debug payload to clipboard.', error)
          copyButton.textContent = 'Copy failed — check console'
          window.setTimeout(() => {
            copyButton.textContent = 'Copy debug JSON'
          }, 3000)
        }
      })

      function setStatus(message, tone = 'info', details) {
        if (!statusContainer.isConnected) {
          document.body.appendChild(statusContainer)
        }
        statusMessage.firstChild?.nodeType === Node.TEXT_NODE
          ? (statusMessage.firstChild.textContent = message)
          : statusMessage.insertBefore(document.createTextNode(message), statusMessage.firstChild)
        while (statusMessage.childNodes.length > 1 && statusMessage.childNodes[1] !== statusDetails) {
          statusMessage.removeChild(statusMessage.childNodes[1])
        }
        statusMessage.style.borderColor =
          tone === 'error' ? 'rgba(220, 38, 38, 0.35)' : tone === 'success' ? 'rgba(22, 163, 74, 0.35)' : 'rgba(96, 84, 208, 0.15)'
        statusMessage.style.color = tone === 'error' ? '#991b1b' : tone === 'success' ? '#0f5132' : '#1f2933'
        const hasDetails = typeof details === 'string' && details.trim().length > 0
        statusDetails.textContent = hasDetails ? details : ''
        toggleButton.disabled = !hasDetails
        toggleButton.style.opacity = hasDetails ? '1' : '0.5'
        toggleButton.style.cursor = hasDetails ? 'pointer' : 'not-allowed'
        detailsVisible = hasDetails
        updateDetailsVisibility()
        debugState.status.push({
          at: new Date().toISOString(),
          tone,
          message,
          details
        })
      }

      function clearStatus() {
        if (!statusContainer.isConnected) return
        statusContainer.style.opacity = '0'
        window.setTimeout(() => {
          statusContainer.remove()
        }, 400)
      }

      function resolveUrl(specifier, base = baseUrl) {
        try {
          return new URL(specifier, base).toString()
        } catch (error) {
          console.warn('[admin boot] Failed to resolve URL for', specifier, error)
          return specifier
        }
      }

      function recordError(error, context) {
        const serialised = error instanceof Error
          ? { message: error.message, stack: error.stack }
          : { message: String(error) }
        debugState.errors.push({ context, error: serialised })
      }

      function loadStylesheet(href) {
        if (!href || document.querySelector(`link[data-admin-css="${href}"]`)) return
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = href
        link.dataset.adminCss = href
        document.head.appendChild(link)
      }

      async function importModule(url, label) {
        const attempt = { label, url, startedAt: Date.now() }
        debugState.attempts.push(attempt)
        try {
          await import(/* @vite-ignore */ url)
          attempt.finishedAt = Date.now()
          attempt.status = 'success'
          console.info(`[admin boot] Loaded ${label} from ${url}`)
          return true
        } catch (error) {
          attempt.finishedAt = Date.now()
          attempt.status = 'error'
          attempt.error = error instanceof Error ? { message: error.message, stack: error.stack } : { message: String(error) }
          recordError(error, `import:${label}`)
          console.warn(`[admin boot] Failed to load ${label} from ${url}`, error)
          return false
        }
      }

      function isLikelyLocalHost(hostname) {
        if (!hostname) return false
        const normalized = hostname.toLowerCase()
        return (
          normalized === 'localhost' ||
          normalized === '127.0.0.1' ||
          normalized === '0.0.0.0' ||
          normalized === '[::1]' ||
          normalized === '::1' ||
          normalized.endsWith('.local') ||
          normalized.endsWith('.test')
        )
      }

      function ensureProcessEnv(mode) {
        const globalTarget = typeof globalThis !== 'undefined' ? globalThis : window
        const processLike = (globalTarget.process = globalTarget.process || {})
        const env = (processLike.env = processLike.env || {})
        const current = typeof env.NODE_ENV === 'string' ? env.NODE_ENV.trim().toLowerCase() : undefined
        if (!current || current !== mode) {
          env.NODE_ENV = mode
        }
      }

      async function loadFromDevServer() {
        ensureProcessEnv('development')
        const devClientCandidates = [
          resolveUrl('@vite/client', originUrl),
          resolveUrl('../@vite/client', baseUrl),
          resolveUrl('../../@vite/client', baseUrl)
        ]

        let clientLoaded = false
        for (const candidate of devClientCandidates) {
          if (await importModule(candidate, 'Vite client')) {
            clientLoaded = true
            break
          }
        }

        const entryCandidates = [
          resolveUrl('src/main.tsx', baseUrl),
          resolveUrl('/src/main.tsx', originUrl),
          resolveUrl('../src/main.tsx', baseUrl)
        ]

        for (const candidate of entryCandidates) {
          if (await importModule(candidate, 'Vite entry')) {
            return clientLoaded || true
          }
        }

        return false
      }

      async function loadStaticBundle(cssUrl, jsUrl) {
        ensureProcessEnv('production')
        loadStylesheet(cssUrl)
        return importModule(jsUrl, 'static admin bundle')
      }

      function readQueryFlag(name) {
        const params = new URLSearchParams(window.location.search)
        if (!params.has(name)) return false
        const value = params.get(name)
        if (value === null) return true
        const normalized = value.trim().toLowerCase()
        if (!normalized) return true
        if (['0', 'false', 'no', 'off', 'disabled'].includes(normalized)) {
          return false
        }
        return true
      }

      async function bootstrap() {
        const configReady =
          typeof globalThis !== 'undefined' && globalThis
            ? globalThis.HarmonySheetsAdminBootConfigReady
            : undefined

        if (configReady && typeof configReady.then === 'function') {
          try {
            await configReady
          } catch (error) {
            console.warn('[admin boot] Supabase config promise rejected.', error)
          }
        }

        const forceDev = readQueryFlag('forceDev')
        const forceStatic = readQueryFlag('forceStatic')
        const localHost = isLikelyLocalHost(window.location.hostname)

        if (forceDev && forceStatic) {
          console.warn('[admin boot] forceDev and forceStatic both set — prioritising forceDev.')
        }

        if (forceDev || (localHost && !forceStatic)) {
          const reason = forceDev
            ? 'Force dev override detected — probing the Vite dev server…'
            : 'Connecting to the Vite dev server…'
          setStatus(
            reason,
            'info',
            JSON.stringify(
              {
                host: window.location.host,
                origin: originUrl.toString(),
                forceDev,
                forceStatic,
                localHost
              },
              null,
              2
            )
          )
          const devLoaded = await loadFromDevServer()
          if (devLoaded) {
            clearStatus()
            return
          }
          const fallbackReason = forceDev
            ? '[admin boot] Vite dev server override active but server was unreachable.'
            : '[admin boot] Vite dev server was not reachable. Falling back to static assets.'
          console.info(fallbackReason)
          setStatus(
            'The Vite dev server was not reachable. Falling back to the static admin bundle…',
            'info',
            JSON.stringify({ attempts: debugState.attempts, errors: debugState.errors }, null, 2)
          )
        } else {
          const reason = forceStatic
            ? '[admin boot] forceStatic flag detected — skipping Vite dev server probe.'
            : '[admin boot] Non-local host detected — skipping Vite dev server probe.'
          console.info(reason)
          setStatus(
            'Running in a non-local environment — loading the static admin dashboard…',
            'info',
            JSON.stringify(
              {
                host: window.location.host,
                origin: originUrl.toString(),
                forceDev,
                forceStatic,
                localHost
              },
              null,
              2
            )
          )
        }

        const cssUrl = resolveUrl('assets/admin.css', baseUrl)
        const jsUrl = resolveUrl('assets/admin.js', baseUrl)

        setStatus('Loading the static admin dashboard…', 'info', JSON.stringify({ cssUrl, jsUrl }, null, 2))
        const staticLoaded = await loadStaticBundle(cssUrl, jsUrl)
        if (staticLoaded) {
          clearStatus()
          return
        }

        const payload = {
          baseUrl: baseUrl.toString(),
          originUrl: originUrl.toString(),
          attempts: debugState.attempts,
          errors: debugState.errors
        }
        setStatus(
          'The admin dashboard bundle failed to load. Inspect the debug details below or see window.HarmonySheetsAdminBoot.',
          'error',
          JSON.stringify(payload, null, 2)
        )
        console.error('[admin boot] Unable to load any admin bundle. Inspect window.HarmonySheetsAdminBoot for details.')
      }

      setStatus('Preparing the admin dashboard…')
      void bootstrap()
    </script>
  </body>
</html>
